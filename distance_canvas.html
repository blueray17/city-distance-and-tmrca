<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>City Distance Graph (Canvas)</title>
  <style>
    body { font-family: sans-serif; }
    #controls {
      margin-bottom: 10px;
    }
    canvas {
      border: 1px solid #ccc;
      display: block;
    }
    label {
      margin-right: 10px;
    }
    .btn {
      padding: 5px 10px;
      margin-left: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>City Distance Graph (Canvas)</h2>
  <div id="controls">
    <label>Distance Threshold: <span id="threshold-value">50</span> km</label>
    <input type="range" id="threshold" min="0" max="10000" value="50" style="width: 800px;">
    <button class="btn" id="decrease">-10</button>
    <button class="btn" id="increase">+10</button>
    <button class="btn" id="refresh">ðŸ”„ ReDraw</button>
    <button class="btn" id="collapse"> Collapse</button>
    <br>
    <label><input type="checkbox" id="toggle-labels" checked> Show Labels</label>
    <label><input type="checkbox" id="toggle-distances" checked> Show Distances</label>
    <div>
    <strong>Select JSON Source:</strong>
    <label><input type="radio" name="jsonSource" value="city_graph_all.json" checked> city_graph_all.json</label>
    <label><input type="radio" name="jsonSource" value="city_graph.json"> city_graph.json</label>
    <label><input type="radio" name="jsonSource" value="distance.json"> distance.json</label>
  </div>
  </div>
  <canvas id="graph" width="1200" height="800"></canvas>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const canvas = document.getElementById("graph");
    const ctx = canvas.getContext("2d");
    const width = canvas.width;
    const height = canvas.height;

    const thresholdSlider = document.getElementById("threshold");
    const thresholdValue = document.getElementById("threshold-value");
    const toggleLabels = document.getElementById("toggle-labels");
    const toggleDistances = document.getElementById("toggle-distances");

    const btnIncrease = document.getElementById("increase");
    const btnDecrease = document.getElementById("decrease");
    const btnReDraw = document.getElementById("refresh");
    const btnCollapse = document.getElementById("collapse");

    let transform = d3.zoomIdentity;
    let nodes = [], edges = [], simulation;

    let threshold = +thresholdSlider.value;
    let showLabels = toggleLabels.checked;
    let showDistances = toggleDistances.checked;

    let draggingNode = null;

    function drawGraph() {
      ctx.save();
      ctx.clearRect(0, 0, width, height);
      ctx.translate(transform.x, transform.y);
      ctx.scale(transform.k, transform.k);

      // Draw edges
      edges.forEach(d => {
        if (d.distance <= threshold) {
          ctx.beginPath();
          ctx.moveTo(d.source.x, d.source.y);
          ctx.lineTo(d.target.x, d.target.y);
          ctx.strokeStyle = "#aaa";
          ctx.stroke();
        }
      });

      // Draw nodes
      nodes.forEach(d => {
        ctx.beginPath();
        ctx.arc(d.x, d.y, 5, 0, 5 * Math.PI);
        ctx.fillStyle = "steelblue";
        ctx.fill();
      });

      ctx.restore();

      // Draw labels (outside zoom transform)
      if (showLabels) {
        nodes.forEach(d => {
          const screen = toScreenPosition(d);
          ctx.fillStyle = "black";
          ctx.font = "12px sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "top";
          ctx.fillText(d.id, screen.x, screen.y + 6);
        });
      }

      // Draw distances
      if (showDistances) {
        edges.forEach(d => {
          if (d.distance <= threshold) {
            const midX = (d.source.x + d.target.x) / 2;
            const midY = (d.source.y + d.target.y) / 2;
            const screen = toScreenPosition({ x: midX, y: midY });
            ctx.fillStyle = "gray";
            ctx.font = "12px sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(Math.round(d.distance) + " km", screen.x, screen.y);
          }
        });
      }
    }

    function toScreenPosition(pos) {
      return {
        x: pos.x * transform.k + transform.x,
        y: pos.y * transform.k + transform.y
      };
    }

    function updateThreshold(newValue) {
      threshold = Math.max(0, Math.min(10000, newValue));  // constrain
      thresholdSlider.value = threshold;
      thresholdValue.textContent = threshold;
      drawGraph();
    }

    thresholdSlider.addEventListener("input", () => {
      updateThreshold(+thresholdSlider.value);
    });

    btnIncrease.addEventListener("click", () => {
      updateThreshold(threshold + 10);
    });

    btnDecrease.addEventListener("click", () => {
      updateThreshold(threshold - 10);
    });

    btnCollapse.addEventListener("click", () => {
      simulation = d3.forceSimulation(nodes)
          .force("link", d3.forceLink(edges)
            .id(d => d.id)
            .distance(d => Math.sqrt(d.distance) * 1)
            .strength(d => d.distance <= threshold ? 1 : 0))
          .force("charge", d3.forceManyBody().strength(50))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force("collide", d3.forceCollide(10))
          .alpha(0.5)
          .restart().on("tick", drawGraph);
    });

    btnReDraw.addEventListener("click", () =>{
      // simulation
      //   .force("link", d3.forceLink(edges)
      //     .id(d => d.id)
      //     .distance(d => Math.sqrt(d.distance) * 20)
      //     .strength(d => d.distance <= threshold ? 1 : 0))
      //   .force("charge", d3.forceManyBody().strength(-50))
      //   .force("center", d3.forceCenter(width / 2, height / 2))
      //   .force("collide", d3.forceCollide(20))
      //   .alpha(1)
      //   .restart();


      simulation = d3.forceSimulation(nodes)
          .force("link", d3.forceLink(edges)
            .id(d => d.id)
            .distance(d => Math.sqrt(d.distance) * 0.1)
            .strength(d => d.distance <= threshold ? 1 : 0))
          .force("charge", d3.forceManyBody().strength(-50))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force("collide", d3.forceCollide(10))
          .alpha(0.5)
          .restart()
          .on("tick", drawGraph);
    });

    toggleLabels.addEventListener("change", () => {
      showLabels = toggleLabels.checked;
      drawGraph();
    });

    toggleDistances.addEventListener("change", () => {
      showDistances = toggleDistances.checked;
      drawGraph();
    });

    canvas.addEventListener("mousedown", (event) => {
      const rect = canvas.getBoundingClientRect();
      const x = (event.clientX - rect.left - transform.x) / transform.k;
      const y = (event.clientY - rect.top - transform.y) / transform.k;

      draggingNode = nodes.find(d => Math.hypot(d.x - x, d.y - y) < 8);
      if (draggingNode) {
        simulation.alphaTarget(0.3).restart();
      }
    });

    canvas.addEventListener("mousemove", (event) => {
      if (draggingNode) {
        const rect = canvas.getBoundingClientRect();
        draggingNode.fx = (event.clientX - rect.left - transform.x) / transform.k;
        draggingNode.fy = (event.clientY - rect.top - transform.y) / transform.k;
        drawGraph();
      }
    });

    canvas.addEventListener("mouseup", () => {
      if (draggingNode) {
        draggingNode.fx = null;
        draggingNode.fy = null;
        simulation.alphaTarget(0);
        draggingNode = null;
      }
    });

    // d3.json("city_graph_all.json").then(data => {
    //   nodes = data.nodes;
    //   edges = data.edges;

    //   simulation = d3.forceSimulation(nodes)
    //     .force("link", d3.forceLink(edges)
    //       .id(d => d.id)
    //       .distance(d => Math.sqrt(d.distance) * 10))
    //     .force("charge", d3.forceManyBody().strength(-300))
    //     .force("center", d3.forceCenter(width / 2, height / 2))
    //     .force("collide", d3.forceCollide(20))
    //     .on("tick", drawGraph);
    // });

    function loadGraph(fileName) {
      d3.json(fileName).then(data => {
        nodes = data.nodes;
        edges = data.edges;

        if (simulation) simulation.stop();

        simulation = d3.forceSimulation(nodes)
          .force("link", d3.forceLink(edges)
            .id(d => d.id)
            .distance(d => Math.sqrt(d.distance) * 0.1)
            .strength(d => d.distance <= threshold ? 1 : 0))
          .force("charge", d3.forceManyBody().strength(-50))
          .force("center", d3.forceCenter(width / 1, height / 1))
          .force("collide", d3.forceCollide(50))
          .alpha(0.5)
          .restart()
          .on("tick", drawGraph)
          ;
      });
    }

    loadGraph("city_graph_all.json");

    d3.select(canvas).call(d3.zoom()
      .scaleExtent([0.1, 10])
      .on("zoom", (event) => {
        transform = event.transform;
        drawGraph();
      }));

    document.querySelectorAll("input[name='jsonSource']").forEach(radio => {
      radio.addEventListener("change", (e) => {
        if (e.target.checked) {
          loadGraph(e.target.value);
        }
      });
    });


  </script>
</body>
</html>
